#!/bin/bash -e

# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

# This script runs proguard on the Flume jars generated by the flume-ng-dist
# module.

ROOT=$(cd $(dirname $0)/../..; pwd)
DIST=$(cd $(dirname $0)/..; pwd)

IN_CONF=$DIST/src/main/resources/flume/proguard.conf

TEST_OUT_CONF=$DIST/target/proguard-tests.conf
MAIN_OUT_CONF=$DIST/target/proguard-main.conf

> $TEST_OUT_CONF
> $MAIN_OUT_CONF

TEST_JARS=$(find $ROOT -type f -name *\.jar | egrep '/flume-.*-tests\.jar')
for JAR in $TEST_JARS; do
  echo "-injars $JAR" >> $TEST_OUT_CONF
done

FLUME_JARS=$(find $DIST/target/apache-flume-*-bin/|grep jar | egrep '(lib|tools)/flume.*jar')
for JAR in $FLUME_JARS; do
  echo "-libraryjars $JAR" >> $TEST_OUT_CONF
  echo "-injars $JAR" >> $MAIN_OUT_CONF
done

LIB_JARS=$(find $DIST/target/apache-flume-*-bin/|grep jar | egrep -v '(lib|tools)/flume.*jar')
for JAR in $LIB_JARS; do
  echo "-libraryjars $JAR" >> $TEST_OUT_CONF
  echo "-libraryjars $JAR" >> $MAIN_OUT_CONF
done

cat $IN_CONF >> $TEST_OUT_CONF
echo "-outjars proguard-test-out" >> $TEST_OUT_CONF

cat $IN_CONF >> $MAIN_OUT_CONF
echo "-outjars proguard-main-out" >> $MAIN_OUT_CONF

set +e
set -x

echo "STARTING TEST PROGUARD"
proguard.sh @$TEST_OUT_CONF
echo "DONE WITH TEST PROGUARD"

echo "STARTING MAIN PROGUARD"
proguard.sh @$MAIN_OUT_CONF
echo "DONE WITH MAIN PROGUARD"
